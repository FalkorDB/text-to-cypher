name: Docker Release Build

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["build"]
    types:
      - completed
    branches: [master]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.1.0-beta.1)'
        required: true
        default: 'v0.1.0-beta.1'

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io

jobs:
  docker-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract release version
        id: extract_version
        run: |
          # Extract version from different trigger types
          if [ "${{ github.event_name }}" = "release" ]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # For workflow_run, extract from the head branch if it's a tag
            if [[ "${{ github.event.workflow_run.head_branch }}" =~ ^v[0-9] ]]; then
              RELEASE_TAG="${{ github.event.workflow_run.head_branch }}"
            else
              echo "Workflow run was not triggered by a tag, skipping Docker build"
              exit 0
            fi
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            RELEASE_TAG="${{ github.ref_name }}"
          else
            RELEASE_TAG="${{ github.event.inputs.version }}"
          fi
          
          # Only proceed if workflow_run was successful (when applicable)
          if [ "${{ github.event_name }}" = "workflow_run" ] && [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "Build workflow did not complete successfully, skipping Docker build"
            exit 0
          fi
          
          VERSION="${RELEASE_TAG#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "Building Docker image for release: ${RELEASE_TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Make docker-build.sh executable
        run: chmod +x ./docker-build.sh

      - name: Wait for release assets to be available
        run: |
          echo "Waiting for release assets to be fully uploaded..."
          VERSION="${{ steps.extract_version.outputs.release_tag }}"
          
          # Enhanced asset checking with build workflow status monitoring
          MAX_ATTEMPTS=60  # 30 minutes total (60 × 30 seconds)
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Checking release assets availability..."
            
            # Check build workflow status first
            if [ "${{ github.event_name }}" = "workflow_run" ]; then
              BUILD_STATUS="${{ github.event.workflow_run.conclusion }}"
              echo "📊 Build workflow status: $BUILD_STATUS"
              if [ "$BUILD_STATUS" = "failure" ] || [ "$BUILD_STATUS" = "cancelled" ]; then
                echo "❌ Build workflow failed/cancelled - no assets will be available"
                exit 1
              fi
            fi
            
            # Check if both required assets exist (package format used by Dockerfile)
            X86_URL="https://github.com/barakb/text-to-cypher/releases/download/${VERSION}/packages/text-to-cypher-linux-x86_64-musl.tar.gz"
            ARM_URL="https://github.com/barakb/text-to-cypher/releases/download/${VERSION}/packages/text-to-cypher-linux-aarch64-musl.tar.gz"
            
            X86_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$X86_URL")
            ARM_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$ARM_URL")
            
            echo "x86_64 asset status: $X86_STATUS"
            echo "aarch64 asset status: $ARM_STATUS"
            
            # Accept both 200 (direct) and 302 (redirect) as success
            X86_OK=false
            ARM_OK=false
            
            if [ "$X86_STATUS" = "200" ] || [ "$X86_STATUS" = "302" ]; then
              X86_OK=true
              echo "✅ x86_64 asset is available"
            else
              echo "⏳ x86_64 asset not ready (status: $X86_STATUS)"
            fi
            
            if [ "$ARM_STATUS" = "200" ] || [ "$ARM_STATUS" = "302" ]; then
              ARM_OK=true
              echo "✅ aarch64 asset is available" 
            else
              echo "⏳ aarch64 asset not ready (status: $ARM_STATUS)"
            fi
            
            # Both assets must be available
            if [ "$X86_OK" = "true" ] && [ "$ARM_OK" = "true" ]; then
              echo "🎉 All release assets are available!"
              break
            fi
            
            # Provide helpful status updates
            if [ $((ATTEMPT % 5)) -eq 0 ]; then
              ELAPSED_MINUTES=$((ATTEMPT * 30 / 60))
              echo "📈 Progress update after $ELAPSED_MINUTES minutes:"
              echo "  - x86_64 build: $([ "$X86_OK" = "true" ] && echo "✅ Complete" || echo "🔄 In progress")"
              echo "  - aarch64 build: $([ "$ARM_OK" = "true" ] && echo "✅ Complete" || echo "🔄 In progress")"
              echo "  - Note: ARM64 builds typically take longer than x86_64"
            fi
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "❌ Timeout after $MAX_ATTEMPTS attempts (30 minutes)"
              echo "Final asset status:"
              echo "  - x86_64: $X86_STATUS ($([ "$X86_OK" = "true" ] && echo "✅ Available" || echo "❌ Missing"))"
              echo "  - aarch64: $ARM_STATUS ($([ "$ARM_OK" = "true" ] && echo "✅ Available" || echo "❌ Missing"))"
              echo ""
              echo "Possible causes:"
              echo "1. Cross-platform build taking longer than 30 minutes"
              echo "2. Build workflow failed for one or both architectures"
              echo "3. GitHub release asset upload issues"
              echo ""
              echo "Next steps:"
              echo "1. Check build workflow: https://github.com/barakb/text-to-cypher/actions"
              echo "2. Check release assets: https://github.com/barakb/text-to-cypher/releases/tag/$VERSION"
              echo "3. Retry this workflow manually if builds completed"
              exit 1
            fi
            
            echo "⏳ Waiting 30 seconds... ($(($ATTEMPT * 30 / 60)) min elapsed, up to 30 min total)"
            sleep 30
            ATTEMPT=$((ATTEMPT + 1))
          done

      - name: Build and push Docker images
        run: |
          # Build and push to GitHub Container Registry
          ./docker-build.sh \
            --version "${{ steps.extract_version.outputs.release_tag }}" \
            --platforms "linux/amd64,linux/arm64" \
            --image-name "text-to-cypher" \
            --registry "${{ env.REGISTRY }}/${{ github.repository_owner }}" \
            --push
          
          # Also build and push without registry prefix for local/Docker Hub use
          ./docker-build.sh \
            --version "${{ steps.extract_version.outputs.release_tag }}" \
            --platforms "linux/amd64,linux/arm64" \
            --image-name "text-to-cypher" \
            --push

  # Verify the built images
  verify-images:
    runs-on: ubuntu-latest
    needs: docker-build
    strategy:
      matrix:
        platform: [linux/amd64, linux/arm64]
    steps:
      - name: Extract release version
        id: extract_version
        run: |
          # Extract version from different trigger types
          if [ "${{ github.event_name }}" = "release" ]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # For workflow_run, extract from the head branch if it's a tag
            if [[ "${{ github.event.workflow_run.head_branch }}" =~ ^v[0-9] ]]; then
              RELEASE_TAG="${{ github.event.workflow_run.head_branch }}"
            else
              echo "Not a tag-triggered workflow run, skipping"
              exit 0
            fi
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            RELEASE_TAG="${{ github.ref_name }}"
          else
            RELEASE_TAG="${{ github.event.inputs.version }}"
          fi
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify image exists and runs
        run: |
          # Pull and test the specific platform image from GitHub Container Registry
          PLATFORM="${{ matrix.platform }}"
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/text-to-cypher:${{ steps.extract_version.outputs.release_tag }}"
          
          echo "Verifying image: ${IMAGE} for platform: ${PLATFORM}"
          
          # Pull the image for the specific platform
          docker pull --platform="${PLATFORM}" "${IMAGE}"
          
          # Basic verification - check if the binary exists and is executable
          docker run --rm --platform="${PLATFORM}" "${IMAGE}" /app/text-to-cypher --help || true
          
          echo "✅ Image verification completed for ${PLATFORM}"

  # Update deployment configurations (optional)
  update-deployment:
    runs-on: ubuntu-latest
    needs: [docker-build, verify-images]
    if: ${{ !github.event.release.prerelease || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_run' }}
    steps:
      - name: Extract release version
        id: extract_version
        run: |
          # Extract version from different trigger types
          if [ "${{ github.event_name }}" = "release" ]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # For workflow_run, extract from the head branch if it's a tag
            if [[ "${{ github.event.workflow_run.head_branch }}" =~ ^v[0-9] ]]; then
              RELEASE_TAG="${{ github.event.workflow_run.head_branch }}"
            else
              echo "Not a tag-triggered workflow run, skipping"
              exit 0
            fi
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref_type }}" = "tag" ]; then
            RELEASE_TAG="${{ github.ref_name }}"
          else
            RELEASE_TAG="${{ github.event.inputs.version }}"
          fi
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

      - name: Update deployment examples
        run: |
          echo "🚀 Docker images built and verified for release: ${{ steps.extract_version.outputs.release_tag }}"
          echo ""
          echo "📦 Available images:"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository_owner }}/text-to-cypher:${{ steps.extract_version.outputs.release_tag }}"
          echo "  - ${{ env.REGISTRY }}/${{ github.repository_owner }}/text-to-cypher:latest"
          echo "  - text-to-cypher:${{ steps.extract_version.outputs.release_tag }}"
          echo "  - text-to-cypher:latest"
          echo ""
          echo "🏃 To run the latest release:"
          echo "  docker run -p 6379:6379 -p 3000:3000 -p 8080:8080 -p 3001:3001 \\"
          echo "    -e DEFAULT_MODEL=gpt-4o-mini -e DEFAULT_KEY=your-key \\"
          echo "    ${{ env.REGISTRY }}/${{ github.repository_owner }}/text-to-cypher:${{ steps.extract_version.outputs.release_tag }}"
          echo ""
          echo "📋 Available platforms: linux/amd64, linux/arm64"

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # 🐳 Docker Release Build Complete
          
          ## Release Information
          - **Version**: \`${{ steps.extract_version.outputs.release_tag }}\`
          - **Repository**: \`${{ github.repository }}\`
          - **Platforms**: linux/amd64, linux/arm64
          
          ## Available Images
          - \`${{ env.REGISTRY }}/${{ github.repository_owner }}/text-to-cypher:${{ steps.extract_version.outputs.release_tag }}\`
          - \`${{ env.REGISTRY }}/${{ github.repository_owner }}/text-to-cypher:latest\`
          - \`text-to-cypher:${{ steps.extract_version.outputs.release_tag }}\`
          - \`text-to-cypher:latest\`
          
          ## Quick Start
          \`\`\`bash
          docker run -p 6379:6379 -p 3000:3000 -p 8080:8080 -p 3001:3001 \\
            -e DEFAULT_MODEL=gpt-4o-mini -e DEFAULT_KEY=your-key \\
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/text-to-cypher:${{ steps.extract_version.outputs.release_tag }}
          \`\`\`
          
          ## Services
          - **Port 6379**: FalkorDB (Redis protocol)
          - **Port 3000**: FalkorDB web interface  
          - **Port 8080**: text-to-cypher HTTP API
          - **Port 3001**: text-to-cypher MCP server
          EOF
